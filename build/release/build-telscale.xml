<?xml version="1.0"?>
<project name="mobicents.sipservlets.release" default="release" basedir=".">
	<property environment="sys"/>
	<property name="release.path" location="${ant.file.mobicents.sipservlets.release}/../target" />
	<property name="base.path" location="${ant.file.mobicents.sipservlets.release}/.." />
	<property name="docs.stage.dir" location="${ant.file.mobicents.sipservlets.release}/../documentation" />
	
	<property name="mss.version" value="6.1.3.GA" />
	<property name="tag.name" value="ts113ga" />
	<property name="mss.release.version" value="${mss.version}" />
	<property name="mss.management.version" value="${mss.version}-TelScale" />
	<property name="mss.snmp.version" value="6.1.2.GA-TelScale" />
	<property name="snmp.tag.name" value="ts112ga" />
	<property name="mss.release.configurations" value="all,default" />
	<property name="mss.release.configurations.jboss5" value="all,default" />
	<property name="mss.release.configurations.jboss5.excluded" value="minimal,standard,web" />
	<property name="mss.release.configurations.eap5" value="production,default" />
	<property name="mss.release.configurations.eap5.excluded" value="all,minimal,standard,web" />
	
	<property name="jboss.version" value="4.2.3.GA" />
	<property name="jboss-5.version" value="5.1.0.GA" />	
	<property name="jboss.download.url" value="http://downloads.sourceforge.net/project/jboss/JBoss/JBoss-${jboss.version}/jboss-${jboss.version}.zip" />
	<property name="jboss-5.download.url" value="http://downloads.sourceforge.net/project/jboss/JBoss/JBoss-${jboss-5.version}/jboss-${jboss-5.version}.zip" />	
	<property name="jboss-5-jdk6.download.url" value="http://downloads.sourceforge.net/project/jboss/JBoss/JBoss-${jboss-5.version}/jboss-${jboss-5.version}-jdk6.zip" />
	
	<property name="tomcat.version" value="6.0.35" />
	<property name="tomcat7.version" value="7.0.27" />
	<property name="tomcat.download.url" value="http://archive.apache.org/dist/tomcat/tomcat-6/v${tomcat.version}/bin/apache-tomcat-${tomcat.version}.zip" />
	<property name="tomcat7.download.url" value="http://archive.apache.org/dist/tomcat/tomcat-7/v${tomcat7.version}/bin/apache-tomcat-${tomcat7.version}.zip" />
	
	<property name="eap-5.x.version" value="5.1.2" />
	<property name="eap-5.version" value="5.1" />
	<property name="eap-5.download.url" value="https://dl.dropbox.com/s/7d75mfdm251e5dx/jboss-eap-5.1.2.zip?dl=1" />

	<property name="mms.version" value="2.1.0.BETA3" />
	<property name="mms.download.url" value="http://downloads.sourceforge.net/project/mobicents/Mobicents%20Media%20Server/${mms.version}/mms-server.zip" />
	<property name="mms.zip.path" value="${base.path}/mobicents-media-server.zip" />
	
	<property name="embjopr.version" value="1.2.0.CR-JBAS4" />
	<property name="embjopr.download.url" value="http://downloads.sourceforge.net/project/rhq/embedded-jopr/embedded-jopr-1.2.0.CR/embedded-jopr-${embjopr.version}.zip" />
	
	<property name="diameter.version" value="1.2.1.GA" />
	<property name="diameter.download.url" value="http://repository.jboss.org/nexus/content/groups/public/org/mobicents/servers/diameter/mobicents-diameter-mux-sar-jboss-4/${diameter.version}/mobicents-diameter-mux-sar-jboss-4-${diameter.version}.sar" />
	<property name="diameter-jboss-5.version" value="1.3.3.FINAL" />
	<property name="diameter-jboss-5.name" value="mobicents-diameter-mux-sar-jboss-5-${diameter-jboss-5.version}.sar"/>
	<property name="diameter-jboss-5.download.url" value="http://repository.jboss.org/nexus/content/groups/public/org/mobicents/servers/diameter/mobicents-diameter-mux-sar-jboss-5/${diameter-jboss-5.version}/${diameter-jboss-5.name}" />
	<property name="diameter.distro.path" value="${base.path}/mobicents-diameter-jboss-4-${diameter.version}.sar" />
	<property name="diameter-jboss-5.distro.path" value="${base.path}/mobicents-diameter-jboss-5-${diameter-jboss-5.version}.sar" />
	
	<property name="tomcat.distro.zip.path" value="${base.path}/apache-tomcat-${tomcat.version}.zip" />
	<property name="tomcat7.distro.zip.path" value="${base.path}/apache-tomcat-${tomcat7.version}.zip" />
	<property name="jboss.distro.zip.path" value="${base.path}/jboss-${jboss.version}.zip" />
	<property name="jboss-5.distro.zip.path" value="${base.path}/jboss-${jboss-5.version}.zip" />
	<property name="jboss-5-jdk6.distro.zip.path" value="${base.path}/jboss-${jboss-5.version}-jdk6.zip" />
	<property name="jboss-5.torquebox.deployer.url" value="http://repository.torquebox.org/maven2/snapshots/org/torquebox/torquebox-core/1.0.0.Beta14-SNAPSHOT/torquebox-core-1.0.0.Beta14-20090709.162929-1-deployer.jar"/>
	<property name="jboss-5.torquebox.deployer.zip.path" value="${base.path}/torquebox-deployer.zip"/>

	<property name="eap-5.distro.zip.path" value="${base.path}/jboss-eap-${eap-5.x.version}.zip" />

	<property name="embjopr.distro.zip.path" value="${base.path}/embjopr-${embjopr.version}.zip" />
	
	<property name="jboss.home" value="${release.path}/jboss-${jboss.version}" />
	<property name="jboss-5.home" value="${release.path}/jboss-${jboss-5.version}" />
	<property name="jboss-5-jdk6.home" value="${release.path}/jboss-jdk6-${jboss-5.version}" />
	<property name="jboss-5-jdk6.home.temp" value="${release.path}/temp" />
	
	<property name="eap-5.home" value="${release.path}/jboss-eap-${eap-5.version}" />
	<property name="eap-5-jdk6.home" value="${release.path}/jboss-eap-${eap-5.version}" />
	<property name="eap-5.home.temp" value="${release.path}/temp" />

	<property name="tomcat.home" value="${release.path}/apache-tomcat-${tomcat.version}" />
	<property name="tomcat7.home" value="${release.path}/apache-tomcat-${tomcat7.version}" />
	<property name="embjopr.war" value="admin-console.war" />
	<property name="embjopr.home" value="${release.path}/${embjopr.war}" />
	<property name="embjopr.home.contents" value="${release.path}/embedded-jopr.war-contents" />
	<!--property name="mss.jopr-plugin-5.version" value="1.6.0.FINAL"/>
	<property name="mss.jopr-plugin-5.url" value="http://deployer:t31sc@1;3@telestax.artifactoryonline.com/telestax/snapshots/org/mobicents/servlet/sip/jopr-mobicents-sip-servlets-as-5-plugin/${mss.jopr-plugin-5.version}/jopr-mobicents-sip-servlets-as-5-plugin-${mss.management.version}.jar"/-->
	<property name="jopr-jmx-plugin-5.url" value="http://repository.jboss.org/nexus/content/groups/public/org/rhq/rhq-jmx-plugin/1.2.0.GA/rhq-jmx-plugin-1.2.0.GA.jar"/>
	
	<condition property="mvn.executable" value="${sys.M2_HOME}\bin\mvn.bat" else="mvn">
		<os family="windows"/>
	</condition>
	
	<taskdef onerror="fail" resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${ant.file.mobicents.release}/../ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>
	
	<!-- Release target -->
	
	<!--target name="release" depends="clean,build-documentation,release-EAP-5.x,release-tomcat,release-jboss-5-jdk6,make-src-zip" /-->
	<target name="release" depends="clean,build-documentation,build-jain-sip-docs,release-jboss-5-jdk6,release-EAP-5.x,release-tomcat7,release-tomcat,make-src-zip" />
	
	<!-- Tomcat version -->
	
	<target name="release-tomcat" depends="extract-tomcat">
		<copy file="TOMCAT-SIP-SERVLETS-README.txt" todir="${tomcat.home}" />
		<copy file="${base.path}/telestax-license.xml" tofile="${tomcat.home}/conf/telestax-license.xml" />

		<mkdir dir="${tomcat.home}/conf/dars"/>
		<copy file="${base.path}/dars/click2call-dar.properties" tofile="${tomcat.home}/conf/dars/mobicents-dar.properties" />
		
		<copy file="${base.path}/server-tomcat-6.xml" tofile="${tomcat.home}/conf/server.xml" />
		<copy file="${base.path}/mss-sip-stack.properties" tofile="${tomcat.home}/conf/mss-sip-stack.properties" />
		
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../..">
			<arg line="clean buildnumber:create install -P set-git-hash -DCATALINA_HOME=${tomcat.home} -P tomcat-distro" />
		</exec>
		
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/click-to-call">
			<arg line="clean install -P set-git-hash" />
		</exec>
		
		<copy tofile="${tomcat.home}/webapps/click2call.war">
			<fileset dir="${base.path}/../../sip-servlets-examples/click-to-call/target/" includes="click-to-call-servlet-*.war" />
		</copy>
		
		<antcall target="deploy-mgmnt">
			<param name="management.deploy.folder" value="${tomcat.home}/webapps" />
		</antcall>

		<antcall target="build-mobicents-sip-load-balancer">
			<param name="mss.home" value="${tomcat.home}"/>
		</antcall>
		
		<mkdir dir="${tomcat.home}/docs" />
		<antcall target="copy-documentation">
			<param name="mss.home" value="${tomcat.home}"/>
		</antcall>
		<antcall target="copy-jain-sip-docs">
			<param name="mss.home" value="${tomcat.home}"/>
		</antcall>
		<antcall target="make-final-zip-tomcat" />
	</target>
	
	<target name="release-tomcat7" depends="extract-tomcat7">
			<copy file="TOMCAT-SIP-SERVLETS-README.txt" todir="${tomcat7.home}" />
			<copy file="${base.path}/telestax-license.xml" tofile="${tomcat7.home}/conf/telestax-license.xml" />

			<mkdir dir="${tomcat7.home}/conf/dars"/>
			<copy file="${base.path}/dars/click2call-async-dar.properties" tofile="${tomcat7.home}/conf/dars/mobicents-dar.properties" />
			
			<copy file="${base.path}/server-tomcat-7.xml" tofile="${tomcat7.home}/conf/server.xml" overwrite="yes"/>
			<copy file="${base.path}/mss-sip-stack.properties" tofile="${tomcat7.home}/conf/mss-sip-stack.properties" />
			<copy file="${base.path}/tomcat7-context-namespaceaware.xml" tofile="${tomcat7.home}/conf/context-namespaceaware.xml.bak"/>		
			
			<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../..">
				<arg line="clean buildnumber:create install -P set-git-hash -DCATALINA_HOME=${tomcat7.home} -P tomcat-7-distro" />
			</exec>
			
			<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/click-to-call-servlet3">
				<arg line="clean install -P set-git-hash" />
			</exec>
			
			<copy tofile="${tomcat7.home}/webapps/Click2CallAsync.war">
				<fileset dir="${base.path}/../../sip-servlets-examples/click-to-call-servlet3/target/" includes="Click2CallAsync.war" />
			</copy>
			
			<antcall target="deploy-mgmnt">
				<param name="management.deploy.folder" value="${tomcat7.home}/webapps" />
			</antcall>

			<antcall target="build-mobicents-sip-load-balancer">
				<param name="mss.home" value="${tomcat7.home}"/>
			</antcall>
			
			<mkdir dir="${tomcat7.home}/docs" />
			<antcall target="copy-documentation">
				<param name="mss.home" value="${tomcat7.home}"/>
			</antcall>
			<antcall target="copy-jain-sip-docs">
				<param name="mss.home" value="${tomcat7.home}"/>
			</antcall>
			<antcall target="make-final-zip-tomcat7" />
		</target>
	
	<!-- JBoss 5 jdk6 version -->
	<target name="release-jboss-5-jdk6" depends="extract-jboss-5-jdk6">
		<for delimiter="," param="jboss.config" list="${mss.release.configurations.jboss5}">
			<sequential>
				<ant dir="${base.path}" antfile="build-telscale.xml" target="release-jboss-5-node">
					<property name="mss.home" value="${jboss-5-jdk6.home}"/>
					<property name="jboss.config" value="@{jboss.config}"/>
					<property name="distro" value="jboss-distro"/>
				</ant>	
				<antcall target="deploy-mss-jopr-plugin-5">			
					<param name="mss.home" value="${jboss-5-jdk6.home}"/>
					<param name="jboss.config" value="@{jboss.config}"/>
				</antcall>
			</sequential>
		</for>
		<!--ant dir="${base.path}" antfile="build-telscale.xml" target="build-mobicents-diameter-jboss-5">
			<property name="mss.home" value="${jboss-5-jdk6.home}"/>
			<property name="jboss.config" value="default"/>
		</ant>
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/diameter-event-charging">
			<arg line="clean install -P set-git-hash" />
		</exec>		
		<copy tofile="${jboss-5-jdk6.home}/server/default/deploy/diameter-event-charging.war">
			<fileset dir="${base.path}/../../sip-servlets-examples/diameter-event-charging/target/" includes="diameter-event-charging-*.war" />
		</copy-->
		<!-- include MMS 2.X -->
		<!--antcall target="extract-mms">
			<param name="mss.home" value="${jboss-5-jdk6.home}"/>
		</antcall-->
		<!-- include JSR309 media example -->
		<!--exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/media-jsr309-servlet">
			<arg line="clean install -P set-git-hash" />
		</exec>
		<copy tofile="${jboss-5-jdk6.home}/server/default/deploy/media-jsr309-servlet.war">
			<fileset dir="${base.path}/../../sip-servlets-examples/media-jsr309-servlet/target/" includes="media-jsr309-servlet.war" />
		</copy>		
		<copy file="JBOSS-SIP-SERVLETS-README.txt" todir="${jboss-5-jdk6.home}" /-->
		<antcall target="build-mobicents-sip-load-balancer">
			<param name="mss.home" value="${jboss-5-jdk6.home}"/>
		</antcall>
		<antcall target="copy-documentation">
			<param name="mss.home" value="${jboss-5-jdk6.home}"/>
		</antcall>
		<antcall target="copy-jain-sip-docs">
			<param name="mss.home" value="${jboss-5-jdk6.home}"/>
		</antcall>
		<!-- include Click to Call example -->
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/click-to-call">
			<arg line="clean install -P set-git-hash" />
		</exec>
				
		<copy tofile="${jboss-5-jdk6.home}/server/default/deploy/click2call.war">
			<fileset dir="${base.path}/../../sip-servlets-examples/click-to-call/target/" includes="click-to-call-servlet-*.war" />
		</copy>				
		
		<!-- don't include diameter and MMS since they are nto productized yet-->
		<!--antcall target="make-final-zip-jboss-5-jdk6" /-->
		<antcall target="make-final-zip-jboss-5-jdk6-lgpl" />
	</target>

	<!-- EAP 5.x version -->
	<target name="release-EAP-5.x" depends="extract-EAP-5.x">
		<for delimiter="," param="jboss.config" list="${mss.release.configurations.eap5}">
			<sequential>
				<ant dir="${base.path}" antfile="build-telscale.xml" target="release-jboss-5-node">
					<property name="mss.home" value="${eap-5.home}/jboss-as"/>
					<property name="jboss.config" value="@{jboss.config}"/>
					<property name="distro" value="eap-distro"/>
				</ant>	
				<copy file="${base.path}/eap-metadata-deployer-jboss-beans.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deployers/metadata-deployer-jboss-beans.xml" />
				<antcall target="deploy-mss-eap-jopr-plugin-5">
					<param name="mss.home" value="${eap-5.home}/jboss-as"/>
					<param name="jboss.config" value="@{jboss.config}"/>
				</antcall>
			</sequential>
		</for>
		<!--ant dir="${base.path}" antfile="build-telscale.xml" target="build-mobicents-diameter-jboss-5">
			<property name="mss.home" value="${jboss-5-jdk6.home}"/>
			<property name="jboss.config" value="default"/>
		</ant>
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/diameter-event-charging">
			<arg line="clean install -P set-git-hash" />
		</exec>		
		<copy tofile="${jboss-5-jdk6.home}/server/default/deploy/diameter-event-charging.war">
			<fileset dir="${base.path}/../../sip-servlets-examples/diameter-event-charging/target/" includes="diameter-event-charging-*.war" />
		</copy-->
		<!-- include MMS 2.X -->
		<!--antcall target="extract-mms">
			<param name="mss.home" value="${jboss-5-jdk6.home}"/>
		</antcall-->
		<!-- include JSR309 media example -->
		<!--exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/media-jsr309-servlet">
			<arg line="clean install -P set-git-hash" />
		</exec>
		<copy tofile="${jboss-5-jdk6.home}/server/default/deploy/media-jsr309-servlet.war">
			<fileset dir="${base.path}/../../sip-servlets-examples/media-jsr309-servlet/target/" includes="media-jsr309-servlet.war" />
		</copy>		
		<copy file="JBOSS-SIP-SERVLETS-README.txt" todir="${jboss-5-jdk6.home}" /-->
		<antcall target="build-mobicents-sip-load-balancer">
			<param name="mss.home" value="${eap-5.home}/jboss-as"/>
		</antcall>
		<antcall target="copy-documentation">
			<param name="mss.home" value="${eap-5.home}/jboss-as"/>
		</antcall>
		<antcall target="copy-jain-sip-docs">
			<param name="mss.home" value="${eap-5.home}/jboss-as"/>
		</antcall>
		<!-- include Click to Call example -->
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/click-to-call">
			<arg line="clean install -P set-git-hash" />
		</exec>
				
		<copy tofile="${eap-5.home}/jboss-as/server/default/deploy/click2call.war">
			<fileset dir="${base.path}/../../sip-servlets-examples/click-to-call/target/" includes="click-to-call-servlet-*.war" />
		</copy>				
		
		<!-- don't include diameter and MMS since they are nto productized yet-->
		<!--antcall target="make-final-zip-jboss-5-jdk6" /-->
		<antcall target="make-final-zip-eap-5.x" />
	</target>		
	
	<target name="release-jboss-5-node">
		<echo message="MSS_HOME= ${mss.home}"/>
		<copy file="${base.path}/telestax-license.xml" tofile="${mss.home}/server/${jboss.config}/conf/telestax-license.xml" />
		<mkdir dir="${mss.home}/server/${jboss.config}/conf/dars" />
		<copy file="${base.path}/dars/click2call-dar.properties" overwrite="true" tofile="${mss.home}/server/${jboss.config}/conf/dars/mobicents-dar.properties" />
		<copy file="${base.path}/mss-sip-stack-jboss-5.properties" overwrite="true" tofile="${mss.home}/server/${jboss.config}/conf/mss-sip-stack.properties" />
		<copy file="${base.path}/server-jboss-5.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/jbossweb.sar/server.xml" />		
		<copy file="${base.path}/jboss-beans.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/jbossweb.sar/META-INF/jboss-beans.xml" />
		<copy file="${base.path}/metadata-deployer-jboss-beans.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deployers/metadata-deployer-jboss-beans.xml" />
		<copy file="${base.path}/war-deployers-jboss-beans.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deployers/jbossweb.deployer/META-INF/war-deployers-jboss-beans.xml" />
		<copy file="${base.path}/profileservice-jboss-beans.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/profileservice-jboss-beans.xml" />
		<copy file="${base.path}/context-jboss-5.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/jbossweb.sar/context.xml" />
		<copy file="${base.path}/jboss-5-log4j.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/conf/jboss-log4j.xml" />
		<!-- https://bitbucket.org/telestax/telscale-sip-servlets/issue/1/security-exploit-on-jboss-510-ga-community -->
		<copy file="${base.path}/jmx-console-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/jmx-console.war/WEB-INF/web.xml" />
		<copy file="${base.path}/jmx-console-jboss-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/jmx-console.war/WEB-INF/jboss-web.xml" />
		<copy file="${base.path}/admin-console-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/admin-console.war/WEB-INF/web.xml" />
		<copy file="${base.path}/invoker-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/http-invoker.sar/invoker.war/WEB-INF/web.xml" />
		<copy file="${base.path}/jbossws-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/jbossws.sar/jbossws-management.war/WEB-INF/web.xml" />
		<copy file="${base.path}/jbossws-jboss-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/jbossws.sar/jbossws-management.war/WEB-INF/jboss-web.xml" />
		<copy file="${base.path}/web-console-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/management/console-mgr.sar/web-console.war/WEB-INF/web.xml" />
		<copy file="${base.path}/web-console-jboss-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/management/console-mgr.sar/web-console.war/WEB-INF/jboss-web.xml" />
		<copy file="${base.path}/web-console-context.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/management/console-mgr.sar/web-console.war/WEB-INF/context.xml" />
		<copy file="${base.path}/ROOT-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/ROOT.war/WEB-INF/web.xml" />
		<copy file="${base.path}/ROOT-jboss-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/ROOT.war/WEB-INF/jboss-web.xml" />
		<copy file="${base.path}/jmx-console-users.properties" overwrite="true" tofile="${mss.home}/server/${jboss.config}/conf/props/jmx-console-users.properties" />
		<!-- End https://bitbucket.org/telestax/telscale-sip-servlets/issue/1/security-exploit-on-jboss-510-ga-community -->
	
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../..">
			<arg line="clean buildnumber:create install -P set-git-hash,jboss-5-distro -DJBOSS_HOME=${mss.home} -Dnode=${jboss.config}" />
		</exec>		
		
		<antcall target="build-mobicents-sglc">
			<param name="mss.home" value="${mss.home}"/>
			<param name="node" value="${jboss.config}"/>
		</antcall>
		
		<!-- only for telscale -->
		<antcall target="build-mobicents-snmp">
			<param name="mss.home" value="${mss.home}"/>
			<param name="node" value="${jboss.config}"/>
			<param name="distro" value="${distro}"/>
		</antcall>
				
		<antcall target="deploy-mgmnt" >
			<param name="management.deploy.folder" value="${mss.home}/server/${jboss.config}/deploy" />
		</antcall>				
		
		<condition property="ha.capable">
			<or>
				<equals arg1="${jboss.config}" arg2="all" />
				<equals arg1="${jboss.config}" arg2="production" />
			</or>
		</condition>
		
		<antcall target="release-jboss-5-node-ha">
			<param name="mss.home" value="${mss.home}" />
		</antcall>
		
	</target>
	
	<target name="release-jboss-5-node-ha" if="ha.capable">
		<echo message="MSS_HOME= ${mss.home}"/>
		<copy overwrite="true" file="${base.path}/mss-sip-stack-jboss-5-all.properties" tofile="${mss.home}/server/${jboss.config}/conf/mss-sip-stack.properties" />
		<copy overwrite="true" file="${base.path}/../../sip-servlets-impl/docs/jboss5/failover-server-jboss-5.xml" tofile="${mss.home}/server/${jboss.config}/deploy/jbossweb.sar/server.xml" />
		<copy overwrite="true" file="${base.path}/context-jboss-5.xml" tofile="${mss.home}/server/${jboss.config}/deploy/jbossweb.sar/context.xml" />
		<copy overwrite="true" file="${base.path}/jboss-beans.xml" tofile="${mss.home}/server/${jboss.config}/deploy/jbossweb.sar/META-INF/jboss-beans.xml" />
		<!--copy overwrite="true" file="${base.path}/metadata-deployer-jboss-beans.xml" tofile="${mss.home}/server/${jboss.config}/deployers/metadata-deployer-jboss-beans.xml" /-->
		<copy overwrite="true" file="${base.path}/jboss-cache-manager-jboss-beans.xml" tofile="${mss.home}/server/${jboss.config}/deploy/cluster/jboss-cache-manager.sar/META-INF/jboss-cache-manager-jboss-beans.xml" />
		<copy overwrite="true" file="${base.path}/failover-war-deployers-jboss-beans.xml" tofile="${mss.home}/server/${jboss.config}/deployers/jbossweb.deployer/META-INF/war-deployers-jboss-beans.xml" />
		<copy file="${base.path}/invoker-web.xml" overwrite="true" tofile="${mss.home}/server/${jboss.config}/deploy/httpha-invoker.sar/invoker.war/WEB-INF/web.xml" />	
		<delete verbose="true" dir="${mss.home}/server/${jboss.config}/deploy/http-invoker.sar"/>

		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/click2call-distributable">
			<arg line="clean install -P set-git-hash" />
		</exec>
									
		<copy tofile="${mss.home}/server/${jboss.config}/deploy/click2call-distributable.war">
			<fileset dir="${base.path}/../../sip-servlets-examples/click2call-distributable/target/" includes="click2call-distributable-*.war" />
		</copy>
			
		<copy overwrite="true" file="${base.path}/../../sip-servlets-examples/click2call-distributable/click2call-distributable-dar.properties" tofile="${mss.home}/server/${jboss.config}/conf/dars/mobicents-dar.properties"/>	
	</target>
	
	<!-- MSS Management Console -->
	
	<target name="deploy-mgmnt">
		<property name="management.home" location="${base.path}/../../management/sip-servlets-management/"/>
		<exec failonerror="true" executable="${mvn.executable}" dir="${management.home}">
			<arg line="clean install -P set-git-hash" />
		</exec>
		<copy file="${management.home}/target/sip-servlets-management.war" tofile="${management.deploy.folder}/sip-servlets-management.war"/>
		<exec executable="wget" dir="${management.deploy.folder}">
			<arg value="-O" />
			<arg value="jolokia.war"/>
			<arg value="http://labs.consol.de/maven/repository/org/jolokia/jolokia-war/1.1.0/jolokia-war-1.1.0.war"/>
		</exec>
	</target>
	
	<target name="deploy-mss-jopr-plugin-5">
		<echo message="MSS_HOME=${mss.home}"/>
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../management/jopr-plugin-as-5">
			<arg line="clean install -P set-git-hash" />
		</exec>
		<move verbose="true" failonerror="false" file="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-jboss-as-5-plugin-2.3.0.EmbJopr.1.2.0-1.jar" tofile="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-jboss-as-5-plugin-2.3.0.EmbJopr.1.2.0-1.jar.bak" />
		<move verbose="true" failonerror="false" file="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-jboss-as-5-plugin.jar" tofile="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-jboss-as-5-plugin.jar.bak" />
		<copy overwrite="true" file="${base.path}/../../management/jopr-plugin-as-5/target/jopr-mobicents-sip-servlets-as-5-plugin-${mss.management.version}.jar" tofile="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-mobicents-sip-servlets-as-5-plugin-${mss.management.version}.jar" />
		<get dest="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/rhq-jmx-plugin-1.2.0.GA.jar" src="${jopr-jmx-plugin-5.url}"/>
	</target>

	<target name="deploy-mss-eap-jopr-plugin-5">
		<echo message="MSS_HOME=${mss.home}"/>
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../management/eap-plugin-as-5">
			<arg line="clean install -P set-git-hash" />
		</exec>		
		<move verbose="true" failonerror="false" file="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-jboss-as-5-plugin-2.3.0.EmbJopr.1.2.0-1.jar" tofile="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-jboss-as-5-plugin-2.3.0.EmbJopr.1.2.0-1.jar.bak" />
		<move verbose="true" failonerror="false" file="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-jboss-as-5-plugin.jar" tofile="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-jboss-as-5-plugin.jar.bak" />
		<copy overwrite="true" file="${base.path}/../../management/eap-plugin-as-5/target/jopr-mobicents-sip-servlets-as-5-plugin-${mss.management.version}.jar" tofile="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/jopr-mobicents-sip-servlets-as-5-plugin-${mss.management.version}.jar" />
		<!--get dest="${mss.home}/server/${jboss.config}/deploy/admin-console.war/plugins/rhq-jmx-plugin-1.2.0.GA.jar" src="${jopr-jmx-plugin-5.url}"/-->
	</target>
	
	<!-- Get dependencies -->
	
	<condition property="dependencies.checkedout">
		<and>
			<available file="${base.path}/target/dependencies/media/1.x/core/.svn/entries" />
			<available file="${base.path}/target/dependencies/media/2.x/core/.svn/entries" />
			<available file="${base.path}/target/dependencies/diameter/.svn/entries" />
			<available file="${base.path}/target/dependencies/sip-balancer/.svn/entries" />
		</and>
	</condition>
	<target name="get-deps" depends="checkout-deps" />
	
	<target name="checkout-deps" unless="dependencies.checkedout">
		<echo>Checking out dependencies</echo>
		<exec executable="${mvn.executable}" dir="${base.path}">
			<arg line="-f external-components-telscale.xml validate -P checkout" />
		</exec>
	</target>
	
	<target name="update-deps">
		<echo>Updating dependencies</echo>
		<exec executable="${mvn.executable}" dir="${base.path}">
			<arg line="-f external-components-telscale.xml validate -P update" />
		</exec>
	</target>
	
	<!-- Build dependencies-->
	
	<target name="build-jain-sip-docs">
		<echo>Building JAIN SIP Docs</echo>

		<exec executable="git">
		    <arg value="clone" />
		    <arg value="-b" />
		    <arg value="ts1-doc" />		    
		    <arg value="https://code.google.com/p/jain-sip.docs" />
		    <arg value="${basedir}/target/dependencies/jain-sip.docs" />
		</exec>

		<!--exec executable="git" dir="${basedir}/target/dependencies/jain-sip.docs">		
		    <arg value="checkout" />
		    <arg value="${tag.name}" />
		</exec-->

		<exec executable="git">
		    <arg value="clone" />		    
		    <arg value="https://telscalejenkins:m0b1c3nts@bitbucket.org/telestax/telscale-jsip.git" />
		    <arg value="${basedir}/target/dependencies/jain-sip" />
		</exec>

		<exec executable="git" dir="${basedir}/target/dependencies/jain-sip">		
		    <arg value="checkout" />
		    <arg value="${tag.name}" />
		</exec>

		<exec executable="git">
		    <arg value="clone" />		    
		    <arg value="https://telscalejenkins:m0b1c3nts@bitbucket.org/telestax/telscale-jsip-ext.git" />
		    <arg value="${basedir}/target/dependencies/jain-sip.ext" />
		</exec>

		<exec executable="git" dir="${basedir}/target/dependencies/jain-sip.ext">		
		    <arg value="checkout" />
		    <arg value="${tag.name}" />
		</exec>

		<exec executable="git">
		    <arg value="clone" />		    
		    <arg value="https://telscalejenkins:m0b1c3nts@bitbucket.org/telestax/telscale-jsip-ha.git" />
		    <arg value="${basedir}/target/dependencies/jain-sip.ha" />
		</exec>

		<exec executable="git" dir="${basedir}/target/dependencies/jain-sip.ha">		
		    <arg value="checkout" />
		    <arg value="${tag.name}" />
		</exec>

		<ant dir="${basedir}/target/dependencies/jain-sip" antfile="${basedir}/target/dependencies/jain-sip/build.xml" target="javadoc"/>		

		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/jain-sip.docs">
			<arg line="clean install -P set-git-hash,maven-release,telscale -Dmaven.test.skip=true -Dproject.build.sourceEncoding=UTF-8" />
		</exec>

		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/jain-sip.ext">
			<arg line="package javadoc:javadoc -Dmaven.test.skip=true -Dproject.build.sourceEncoding=UTF-8" />
		</exec>

		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/jain-sip.ha">
			<arg line="package javadoc:javadoc -Dmaven.test.skip=true -Dproject.build.sourceEncoding=UTF-8" />
		</exec>
	</target>

	<target name="copy-jain-sip-docs">
		<echo>Copying JAIN SIP Docs</echo>

		<mkdir dir="${mss.home}/docs/jain-sip"/>
		<copy overwrite="true" todir="${mss.home}/docs/jain-sip">
			<fileset dir="${basedir}/target/dependencies/jain-sip.docs/jdocbook-telscale/target/docbook/publish/en-US/" />
		</copy>
		
		<mkdir dir="${mss.home}/docs/jain-sip-apidocs"/>
		<copy overwrite="true" todir="${mss.home}/docs/jain-sip-apidocs">
			<fileset dir="${basedir}/target/dependencies/jain-sip/javadoc/" />
		</copy>

		<mkdir dir="${mss.home}/docs/jain-sip-ext-apidocs"/>
		<copy overwrite="true" todir="${mss.home}/docs/jain-sip-ext-apidocs">
			<fileset dir="${basedir}/target/dependencies/jain-sip.ext/target/site/apidocs" />
		</copy>

		<mkdir dir="${mss.home}/docs/jain-sip-ha-apidocs"/>
		<mkdir dir="${mss.home}/docs/jain-sip-ha-apidocs/core"/>
		<mkdir dir="${mss.home}/docs/jain-sip-ha-apidocs/jboss-5"/>
		<copy overwrite="true" todir="${mss.home}/docs/jain-sip-ha-apidocs/core">
			<fileset dir="${basedir}/target/dependencies/jain-sip.ha/core/target/site/apidocs" />
		</copy>
		<copy overwrite="true" todir="${mss.home}/docs/jain-sip-ha-apidocs/jboss-5">
			<fileset dir="${basedir}/target/dependencies/jain-sip.ha/jboss-5/target/site/apidocs" />
		</copy>
	</target>

	<target name="build-mobicents-sip-load-balancer" depends="get-deps">
		<echo>Building SIP Load Balancer</echo>

		<exec executable="git">
		    <arg value="clone" />
		    <arg value="-b" />
		    <arg value="ts1" />
		    <arg value="https://telscalejenkins:m0b1c3nts@bitbucket.org/telestax/telscale-load-balancer.git" />
		    <arg value="${basedir}/target/dependencies/sip-balancer" />
		</exec>

		<!--exec executable="git" dir="${basedir}/target/dependencies/sip-balancer">		
		    <arg value="checkout" />
		    <arg value="${tag.name}" />
		</exec-->

		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/sip-balancer/jar">
			<arg line="clean install -P set-git-hash -Dmaven.test.skip=true" />
		</exec>
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/sip-balancer/docs">
			<arg line="clean install -P set-git-hash,maven-release,telscale -Dmaven.test.skip=true" />
		</exec>
		<copy tofile="${mss.home}/sip-balancer/sip-balancer-jar-with-dependencies.jar">
			<fileset dir="${base.path}/target/dependencies/sip-balancer/jar/target/" includes="sip-balancer-*-jar-with-dependencies.jar" />
		</copy>
		<mkdir dir="${mss.home}/sip-balancer/docs"/>
		<copy todir="${mss.home}/sip-balancer/docs">
			<fileset dir="${base.path}/target/dependencies/sip-balancer/docs/jdocbook-telscale/target/docbook/publish/en-US" includes="**/*" />
		</copy>		
		<copy file="${base.path}/target/dependencies/sip-balancer/jar/src/test/resources/lb-configuration.properties"
			tofile="${mss.home}/sip-balancer/lb-configuration.properties" />
		<copy file="${base.path}/target/dependencies/sip-balancer/jar/src/test/resources/lb-log4j.xml"
			tofile="${mss.home}/sip-balancer/lb-log4j.xml" />
		<copy file="${base.path}/target/dependencies/sip-balancer/jar/src/test/resources/telestax-license.xml"
			tofile="${mss.home}/sip-balancer/telestax-license.xml" />
	</target>
	
	<target name="build-mobicents-sglc" depends="get-deps">
		<echo>Building Simple Global Logging Configuration</echo>
		<echo message="jboss.home= ${mss.home}"/>
		<echo message="node= ${node}"/>
		<echo message="distro= ${distro}"/>
		<copy overwrite="true" verbose="true" todir="${base.path}/target/dependencies/sglc/sar/target/mobicents-sglc/log4j-templates">
		    <fileset dir="${base.path}/sglc-templates">
		      <include name="**/*.xml.*"/>
		    </fileset>
		  </copy>
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/sglc">
			<arg line="clean install -P set-git-hash -Dmaven.test.skip=true -Djboss.home=${mss.home} -Dnode=${node}" />
		</exec>			
	</target>
	
	<!-- only for telscale -->
	<target name="build-mobicents-snmp" depends="get-deps">
		<echo>Building SNMP Adaptor</echo>
		
		<exec executable="git">
		    <arg value="clone" />
		    <arg value="-b" />
		    <arg value="ts1-old" />
		    <arg value="https://telscalejenkins:m0b1c3nts@bitbucket.org/telestax/telscale-snmp-adaptor.git" />
		    <arg value="${basedir}/target/dependencies/snmp-adaptor" />
		</exec>

		<exec executable="git" dir="${basedir}/target/dependencies/snmp-adaptor">		
		    <arg value="checkout" />
		    <arg value="${snmp.tag.name}" />
		</exec>

		<echo message="jboss.home= ${mss.home}"/>
		<echo message="node= ${node}"/>	
		<delete verbose="true" dir="${mss.home}/server/${node}/deploy/snmp-adaptor.sar"/>
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/snmp-adaptor/mibgen">
			<arg line="clean install" />
		</exec>	
		<copy overwrite="true" verbose="true" todir="${mss.home}/client">
		    <fileset dir="${base.path}/target/dependencies/snmp-adaptor/mibgen/plugin/target">
		      <include name="**/mibgen*.jar"/>
		    </fileset>
		</copy>

		<exec executable="wget" dir="${basedir}/target/dependencies/snmp-adaptor">
			<arg value="-O" />
			<arg value="trove-2.1.1.pom"/>
			<arg value="https://maven.nuxeo.org/nexus/content/groups/public/trove/trove/2.1.1/trove-2.1.1.pom"/>
		</exec>

		<exec executable="wget" dir="${basedir}/target/dependencies/snmp-adaptor">
			<arg value="-O" />
			<arg value="trove-2.1.1.jar"/>
			<arg value="https://maven.nuxeo.org/nexus/content/groups/public/trove/trove/2.1.1/trove-2.1.1.jar"/>
		</exec>

		<exec executable="mvn" dir="${basedir}/target/dependencies/snmp-adaptor">
			<arg value="install:install-file" />
			<arg value="-Dfile=trove-2.1.1.pom"/>
			<arg value="-DgroupId=trove"/>
			<arg value="-DartifactId=trove"/>
			<arg value="-Dversion=2.1.1"/>
			<arg value="-Dpackaging=pom"/>
		</exec>

		<exec executable="mvn" dir="${basedir}/target/dependencies/snmp-adaptor">
			<arg value="install:install-file" />
			<arg value="-Dfile=trove-2.1.1.jar"/>
			<arg value="-DgroupId=trove"/>
			<arg value="-DartifactId=trove"/>
			<arg value="-Dversion=2.1.1"/>
			<arg value="-Dpackaging=jar"/>
		</exec>

		<echo message="node= ${node}"/>
		<echo message="mss.home= ${mss.home}"/>
		<echo message="distro= ${distro}"/>

		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/snmp-adaptor/adaptor">
			<arg line="clean install -Dmaven.test.skip=true -Djboss.home=${mss.home} -Dnode=${node}" />
		</exec>			
		<echo>Building SNMP Deployer</echo>
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/snmp-adaptor/deployer">
			<arg line="clean install -P ${distro} -Dmaven.test.skip=true -DJBOSS_HOME=${mss.home} -Dnode=${node}" />
		</exec>	
		<copy overwrite="true" file="${base.path}/management/snmp/jboss-service.xml" tofile="${mss.home}/server/${jboss.config}/deploy/snmp-adaptor.sar/META-INF/jboss-service.xml" />
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/target/dependencies/snmp-adaptor/mibgen">
			<arg line="clean install -P ${distro} -Dmaven.test.skip=true -DJBOSS_HOME=${mss.home} -Dnode=${node}" />
		</exec>	
		<copy overwrite="true" file="${base.path}/target/dependencies/snmp-adaptor/mibgen/generator/target/mibgen-generator-${mss.snmp.version}-executable.jar" tofile="${mss.home}/client/mibgen-generator-${mss.snmp.version}-executable.jar" />
	</target>
	
	<!-- Download dependencies from SourceForge -->
	
	<target name="build-mobicents-diameter-jboss-5" depends="get-mobicents-diameter-jboss-5">		
		<unzip dest="${mss.home}/server/${jboss.config}/deploy/${diameter-jboss-5.name}" src="${diameter-jboss-5.distro.path}"/>
		<copy overwrite="true" file="${base.path}/jdiameter-config.xml" tofile="${mss.home}/server/${jboss.config}/deploy/${diameter-jboss-5.name}/config/jdiameter-config.xml" />
	</target>
	
	<available file="${diameter-jboss-5.distro.path}" property="got.mobicents-diameter-jboss-5" />
		<target name="get-mobicents-diameter-jboss-5" unless="got.mobicents-diameter-jboss-5">
			<echo>Downloading Mobicents Diameter JBoss5</echo>
				<get dest="${diameter-jboss-5.distro.path}" src="${diameter-jboss-5.download.url}" />
		</target>
	
	<!-- Fetch and build documentation -->
	<target name="build-documentation" >
		<echo>Building documentation</echo>

		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../docs">
			<arg line="clean install -P telscale -Dproject.build.sourceEncoding=UTF-8" />
		</exec>
	</target>
	
	<target name="copy-documentation">
		<copy overwrite="true" todir="${mss.home}/docs/mobicents-sip-servlets">
			<fileset dir="${base.path}/../../docs/jdocbook-telscale/target/docbook/publish/en-US/" />
		</copy>
		<mkdir dir="${mss.home}/docs/mobicents-sip-servlets/jsr-289-api"/>
		<copy overwrite="true" todir="${mss.home}/docs/mobicents-sip-servlets/jsr-289-api">
			<fileset dir="../jsr289-apidocs/" />
		</copy>
		<mkdir dir="${mss.home}/docs/mobicents-sip-servlets/jsr-289-api-extensions"/>
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-client">
			<arg line="javadoc:javadoc" />
		</exec>
		<copy overwrite="true" todir="${mss.home}/docs/mobicents-sip-servlets/jsr-289-api-extensions">
			<fileset dir="${base.path}/../../sip-servlets-client/target/site/apidocs/" />
		</copy>

		<!--delete dir="${docs.stage.dir}" /-->
	</target>
	
	<!-- zip source project that can be used to build release -->
	
	<target name="set-src-excludes">
		<defaultexcludes add="**/target/**" />
		<defaultexcludes add="**/design-docs/**" />
		<defaultexcludes add="**/legacy/**" />
		<defaultexcludes add="**/release/**" />
		<defaultexcludes add="**/logs/**" />
		<defaultexcludes add="**/tests/**" />
		<defaultexcludes add="**/build/**" />
		<defaultexcludes add="**/GWT/**" />
		<defaultexcludes add="**/${*}/**" />
		<defaultexcludes add="**/*JBOSS_HOME*/**" />
		<defaultexcludes add="**/*CATALINA_HOME*/**" />
		<defaultexcludes add="**/.gwt-cache/**" />
		<defaultexcludes add="**/.settings/**" />
		<defaultexcludes add="**/.project" />
		<defaultexcludes add="**/.classpath" />
		<defaultexcludes add="**/*.class" echo="true"/>
	</target>
	
	<target name="make-src-zip"  depends="set-time-stamp,set-src-excludes">
		<property name="zip.filename" value="TelScale-SIP-Servlets-${mss.release.version}-${time.stamp}-src.zip" />
		
		<copy todir="${release.path}/src/mobicents/servers/sip-servlets" includeEmptyDirs="false">
			<fileset dir="${base.path}/../.."
				includes="**/pom.xml **/sip-servlets-annotations/** **/sip-servlets-application-router/** **/containers/sip-servlets-catalina/** **/containers/sip-servlets-catalina-7/** **/sip-servlets-client/** **/sip-servlets-core-api/** **/sip-servlets-examples/** **/sip-servlets-impl/** **/containers/sip-servlets-jboss5/** **/containers/sip-servlets-jboss5-deployer/** **/containers/sip-servlets-jboss5-ha-server-cache/** **/containers/sip-servlets-jboss5-metadata/** **/sip-servlets-jruby/** **/management/sip-servlets-management/** **/sip-servlets-spec/** **/containers/sip-servlets-tomcat-jboss4/** **/containers/tomcat7/** **/containers/sip-servlets-as7/** **/containers/sip-servlets-as7-drop-in/**"
				excludes="**/mobicents-skin/** **/sip-servlets-impl/null/** " />
		</copy>
		
		<zip destfile="${base.path}/${zip.filename}" basedir="${release.path}/src"/>
		<delete dir="${release.path}/src"/>
		
		<defaultexcludes default="true"/>
	</target>
	
	<!-- zip binary distributions -->
	
	<!--target name="make-final-zip-jboss-5-jdk6" depends="set-time-stamp">
		<fixcrlf srcdir="${jboss-5-jdk6.home}/bin" includes="*.sh" eol="lf" eof="remove" />
		<fixcrlf srcdir="${jboss-5-jdk6.home}/mobicents-media-server/mms-server/bin" includes="*.sh" eol="lf" eof="remove" />
		<zip destfile="${base.path}/mss-${mss.release.version}-jboss-jdk6-${jboss-5.version}-${time.stamp}-full.zip" filesonly="false">
			<zipfileset dir="${jboss-5-jdk6.home}/bin" filemode="755" prefix="mss-${mss.release.version}-jboss-jdk6-${jboss-5.version}/bin">
				<include name="*.sh" />
			</zipfileset>			
			<zipfileset dir="${jboss-5-jdk6.home}/bin" prefix="mss-${mss.release.version}-jboss-jdk6-${jboss-5.version}/bin">
				<exclude name="*.sh" />
			</zipfileset>
			<zipfileset dir="${jboss-5-jdk6.home}/mobicents-media-server/mms-server/bin" filemode="755" prefix="mss-${mss.release.version}-jboss-jdk6-${jboss-5.version}/mobicents-media-server/mms-server/bin">
				<include name="*.sh" />
			</zipfileset>
			<zipfileset dir="${jboss-5-jdk6.home}/mobicents-media-server/mms-server/bin" prefix="mss-${mss.release.version}-jboss-jdk6-${jboss-5.version}/mobicents-media-server/mms-server/bin">
				<exclude name="*.sh" />
			</zipfileset>
			<zipfileset dir="${jboss-5-jdk6.home}" prefix="mss-${mss.release.version}-jboss-jdk6-${jboss-5.version}" excludes="**/bin/** **/server/*/data/** **/server/*/log/** **/server/*/tmp/** **/server/*/work/** **/server/tmp/**"/>
		</zip>
	</target-->
	
	<target name="make-final-zip-jboss-5-jdk6-lgpl" depends="set-time-stamp">
		<!--delete dir="${jboss-5-jdk6.home}/mobicents-media-server"/>
		<delete dir="${jboss-5-jdk6.home}/server/default/deploy/${diameter-jboss-5.name}"/>		
		<delete file="${jboss-5-jdk6.home}/server/default/deploy/diameter-event-charging.war"/>
		<delete file="${jboss-5-jdk6.home}/server/default/deploy/media-jsr309-servlet.war"/-->
		<delete file="${jboss-5-jdk6.home}/docs/licenses/GPL-LICENSE.TXT"/>
		<fixcrlf srcdir="${jboss-5-jdk6.home}/bin" includes="*.sh" eol="lf" eof="remove" />		
		<zip destfile="${base.path}/TelScale-SIP-Servlets-${mss.release.version}-jboss-as-${jboss-5.version}-${time.stamp}.zip" filesonly="false">
			<zipfileset dir="${jboss-5-jdk6.home}/bin" filemode="755" prefix="TelScale-SIP-Servlets-${mss.release.version}-jboss-as-${jboss-5.version}/bin">
				<include name="*.sh" />
			</zipfileset>			
			<zipfileset dir="${jboss-5-jdk6.home}/bin" prefix="TelScale-SIP-Servlets-${mss.release.version}-jboss-as-${jboss-5.version}/bin">
				<exclude name="*.sh" />
			</zipfileset>			
			<zipfileset dir="${jboss-5-jdk6.home}" prefix="TelScale-SIP-Servlets-${mss.release.version}-jboss-as-${jboss-5.version}" excludes="**/bin/** **/server/*/data/** **/server/*/log/** **/server/*/tmp/** **/server/*/work/** **/server/tmp/**"/>
		</zip>
	</target>

	<target name="make-final-zip-eap-5.x" depends="set-time-stamp">
		<!--delete dir="${eap-5.home}/mobicents-media-server"/>
		<delete dir="${eap-5.home}/server/default/deploy/${diameter-jboss-5.name}"/>		
		<delete file="${eap-5.home}/server/default/deploy/diameter-event-charging.war"/>
		<delete file="${eap-5.home}/server/default/deploy/media-jsr309-servlet.war"/-->
		<delete file="${eap-5.home}/jboss-as/docs/licenses/GPL-LICENSE.TXT"/>
		<fixcrlf srcdir="${eap-5.home}/jboss-as/bin" includes="*.sh" eol="lf" eof="remove" />		
		<zip destfile="${base.path}/TelScale-SIP-Servlets-${mss.release.version}-jboss-eap-${eap-5.x.version}-${time.stamp}.zip" filesonly="false">
			<zipfileset dir="${eap-5.home}/jboss-as/bin" filemode="755" prefix="TelScale-SIP-Servlets-${mss.release.version}-jboss-eap-${eap-5.version}/jboss-as/bin">
				<include name="*.sh" />
			</zipfileset>			
			<zipfileset dir="${eap-5.home}/jboss-as/bin" prefix="TelScale-SIP-Servlets-${mss.release.version}-jboss-eap-${eap-5.version}/jboss-as/bin">
				<exclude name="*.sh" />
			</zipfileset>			
			<zipfileset dir="${eap-5.home}" prefix="TelScale-SIP-Servlets-${mss.release.version}-jboss-eap-${eap-5.version}" excludes="**/jboss-as/bin/** **/server/*/data/** **/server/*/log/** **/server/*/tmp/** **/server/*/work/** **/server/tmp/**"/>
		</zip>
	</target>
	
	<target name="make-final-zip-tomcat" depends="set-time-stamp">
		<fixcrlf srcdir="${tomcat.home}/bin" includes="*.sh" eol="lf" eof="remove" />
		<zip destfile="${base.path}/TelScale-SIP-Servlets-${mss.release.version}-apache-tomcat-${tomcat.version}-${time.stamp}.zip" filesonly="false">
			<zipfileset dir="${tomcat.home}/bin" filemode="755" prefix="TelScale-SIP-Servlets-${mss.release.version}-apache-tomcat-${tomcat.version}/bin">
				<include name="*.sh" />
			</zipfileset>
			<zipfileset dir="${tomcat.home}/bin" prefix="TelScale-SIP-Servlets-${mss.release.version}-apache-tomcat-${tomcat.version}/bin">
				<exclude name="*.sh" />
			</zipfileset>
			<zipfileset dir="${tomcat.home}" prefix="TelScale-SIP-Servlets-${mss.release.version}-apache-tomcat-${tomcat.version}" excludes="**/bin/**"/>
		</zip>
	</target>
	
	<target name="make-final-zip-tomcat7" depends="set-time-stamp">
		<fixcrlf srcdir="${tomcat7.home}/bin" includes="*.sh" eol="lf" eof="remove" />
		<zip destfile="${base.path}/TelScale-SIP-Servlets-${mss.release.version}-apache-tomcat-${tomcat7.version}-${time.stamp}.zip" filesonly="false">
			<zipfileset dir="${tomcat7.home}/bin" filemode="755" prefix="TelScale-SIP-Servlets-${mss.release.version}-apache-tomcat-${tomcat7.version}/bin">
				<include name="*.sh" />
			</zipfileset>
			<zipfileset dir="${tomcat7.home}/bin" prefix="TelScale-SIP-Servlets-${mss.release.version}-apache-tomcat-${tomcat7.version}/bin">
				<exclude name="*.sh" />
			</zipfileset>
			<zipfileset dir="${tomcat7.home}" prefix="TelScale-SIP-Servlets-${mss.release.version}-apache-tomcat-${tomcat7.version}" excludes="**/bin/**"/>
		</zip>
	</target>
	
	<target name="set-time-stamp" unless="skip.timestamp">
		<tstamp>
			<format property="time.stamp" pattern="yyMMddHHmm" />
		</tstamp>
	</target>
	
	<!-- The cleanup target -->
	
	<target name="clean">
		<delete dir="${jboss.home}" />
		<delete dir="${jboss-5.home}" />
		<delete dir="${jboss-5-jdk6.home}" />
		<delete dir="${tomcat.home}" />
		<delete dir="${tomcat7.home}" />
		<delete dir="${eap-5.home}" />
		<delete dir="${release.path}"/>
		<delete>
		    <fileset dir="${base.path}" includes="TelScale-SIP-Servlets-${mss.release.version}*.zip"/>
		</delete>
	</target>
	
	<!-- Download and dependency building -->
	
	<available file="${jboss-5-jdk6.distro.zip.path}" property="got.jboss-5-jdk6" />
	<target name="get-jboss-5-jdk6" unless="got.jboss-5-jdk6">
		<echo>Downloading JBoss AS 5</echo>
		<get dest="${jboss-5-jdk6.distro.zip.path}" src="${jboss-5-jdk6.download.url}"/>
	</target>
	
	<available file="${mms.zip.path}" property="got.mms" />
	<target name="get-mms" unless="got.mms">
		<echo>Downloading JBoss AS 5</echo>
		<get dest="${mms.zip.path}" src="${mms.download.url}"/>
	</target>
	
	<available file="${jboss-5.torquebox.deployer.zip.path}" property="got.jboss-5-torquebox-deployer" />
	<target name="get-jboss-5-torquebox-deployer" unless="got.jboss-5-torquebox-deployer">
		<echo>Downloading JBoss AS 5 Torquebox Deployer</echo>
		<get dest="${jboss-5.torquebox.deployer.zip.path}" src="${jboss-5.torquebox.deployer.url}"/>
	</target>
	
	<target name="extract-jboss-5-jdk6" depends="get-jboss-5-jdk6">
		<delete dir="${jboss-5-jdk6.home}" failonerror="true" />
		<unzip src="${jboss-5-jdk6.distro.zip.path}" dest="${jboss-5-jdk6.home.temp}"/>
		<move todir="${jboss-5-jdk6.home}">
			<fileset dir="${jboss-5-jdk6.home.temp}/jboss-${jboss-5.version}"/>
		</move>
		
		<echo>Included profiles: ${mss.release.configurations.jboss5} -&gt; Excludes list: ${used.configurations.jboss5}</echo>
		
		<delete dir="${jboss-5-jdk6.home}/server/minimal" includeemptydirs="true" failonerror="false" verbose="false"/>			
		<delete dir="${jboss-5-jdk6.home}/server/web" includeemptydirs="true" failonerror="false" verbose="false"/>
		<delete dir="${jboss-5-jdk6.home}/server/standard" includeemptydirs="true" failonerror="false" verbose="false"/>
	</target>

	<available file="${eap-5.distro.zip.path}" property="got.eap-5" />
	<target name="get-eap-5" unless="got.eap-5">
		<echo>Downloading EAP 5</echo>
		<get dest="${eap-5.distro.zip.path}" src="${eap-5.download.url}"/>
	</target>

	<target name="extract-EAP-5.x" depends="get-eap-5">
		<delete dir="${eap-5.home}" failonerror="true" />
		<unzip src="${eap-5.distro.zip.path}" dest="${eap-5.home.temp}"/>
		<move todir="${eap-5.home}">
			<fileset dir="${eap-5.home.temp}/jboss-eap-${eap-5.version}"/>
		</move>
		
		<echo>Included profiles: ${mss.release.configurations.eap5} -&gt; Excludes list: ${used.configurations.eap5}</echo>
		
		<delete dir="${eap-5.home}/jboss-as/server/minimal" includeemptydirs="true" failonerror="false" verbose="false"/>			
		<delete dir="${eap-5.home}/jboss-as/server/web" includeemptydirs="true" failonerror="false" verbose="false"/>
		<delete dir="${eap-5.home}/jboss-as/server/standard" includeemptydirs="true" failonerror="false" verbose="false"/>
		<delete dir="${eap-5.home}/jboss-as/server/all" includeemptydirs="true" failonerror="false" verbose="false"/>
		<!-- unsigning EAP >
		<exec executable="bash">
		    <arg value="-c"/>
		    <arg value="find ${eap-5.home} -name '*.jar' -print0 | xargs -0 -I JAR zip -d JAR META-INF/JBOSSCOD.*"/>
		</exec-->
	</target>
	
	<target name="extract-mms" depends="get-mms">
		<mkdir dir="${mss.home}/mobicents-media-server"/>
		<unzip src="${mms.zip.path}" dest="${mss.home}/mobicents-media-server" />
	</target>
	
	<target name="extract-jboss-5-torquebox-deployer" depends="get-jboss-5-torquebox-deployer">			
		<unzip src="${jboss-5.torquebox.deployer.zip.path}" dest="${jboss-5.home}/server/default/deployers/torquebox.deployer" />					
	</target>
	
	<target name="extract-jboss-5-torquebox-deployer-for-jdk6" depends="get-jboss-5-torquebox-deployer">			
		<unzip src="${jboss-5.torquebox.deployer.zip.path}" dest="${jboss-5-jdk6.home}/server/default/deployers/torquebox.deployer" />					
	</target>
	
	<available file="${tomcat.distro.zip.path}" property="got.tomcat" />
	<target name="get-tomcat" unless="got.tomcat">
		<echo>Downloading Apache Tomcat</echo>
		<get dest="${tomcat.distro.zip.path}" src="${tomcat.download.url}"/>
	</target>
	
	<available file="${tomcat7.distro.zip.path}" property="got.tomcat7" />
	<target name="get-tomcat7" unless="got.tomcat7">
		<echo>Downloading Apache Tomcat</echo>
		<get dest="${tomcat7.distro.zip.path}" src="${tomcat7.download.url}"/>
	</target>
	
	<target name="extract-tomcat" depends="get-tomcat">
		<delete dir="${tomcat.home}" failonerror="true" />
		<unzip src="${tomcat.distro.zip.path}" dest="${tomcat.home}/.." />
	</target>
	
	<target name="extract-tomcat7" depends="get-tomcat7">
		<delete dir="${tomcat7.home}" failonerror="true" />
		<unzip src="${tomcat7.distro.zip.path}" dest="${tomcat7.home}/.." />
	</target>
	
	<available file="${embjopr.distro.zip.path}" property="got.jopr" />
	<target name="get-embjopr" unless="got.jopr">
		<echo>Downloading Embedded Jopr</echo>
		<get dest="${embjopr.distro.zip.path}" src="${embjopr.download.url}"/>
	</target>
	
	<target name="extract-embjopr" depends="get-embjopr">
		<delete dir="${embjopr.home}" failonerror="true" />
		<unzip src="${embjopr.distro.zip.path}" dest="${embjopr.home}/.." />
		<mkdir dir="${embjopr.home.contents}"/>
		<unjar src="${embjopr.home}" dest="${embjopr.home.contents}" />
	</target>
	
</project>
